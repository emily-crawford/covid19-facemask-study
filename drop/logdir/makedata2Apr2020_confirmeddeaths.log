-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  D:\Dropbox (yale som economics)\COVID-19 Masks\Logfiles\makedata2Apr2020_confirmeddeaths.log
  log type:  text
 opened on:   2 Apr 2020, 12:51:27

. clear;

. **Load Oxford data and update date format;
. insheet using "`datadir'\OxCGRT_Download_latest_data.csv";
(35 vars, 9,283 obs)

. rename countryname country;

. tostring date, usedisplayformat replace;
date was long now str8

. gen newdate = date(date,"YMD");

. tempfile oxdata;

. save `oxdata', replace;
(note: file C:\Users\jabal\AppData\Local\Temp\ST_4864_000002.tmp not found)
file C:\Users\jabal\AppData\Local\Temp\ST_4864_000002.tmp saved

. *Load infection rate and death data;
. clear;

. insheet using "`datadir'\Reports.csv";
(47 vars, 64,986 obs)

. /*;
> **When not commented out, create a list of countries and states in the data;
> 
> *Create country and (country, state) csvs;
> preserve;
> keep country state;
> sort country state;
> gen hascomma = strpos(state,",");
> drop if hascomma != 0;
> drop hascomma;
> drop if state == "";
> duplicates drop;
> outsheet using "`datadir'\allcountrystates.csv", comma replace;
> restore;
> 
> preserve;
> keep country;
> sort country;
> duplicates drop;
> outsheet using "`datadir'\allcountries.csv", comma replace;
> restore;
> */;
. **Rename countries so that they merge with mask data;
. replace country = "United States of America" if country == "United States";
(33,782 real changes made)

. replace country = "Russia" if strpos(country,"Russia");
(62 real changes made)

. replace country = "Iran" if strpos(country,"Iran");
(43 real changes made)

. replace country = "South Korea" if country == "Korea, Republic of";
(164 real changes made)

. replace country = "Taiwan" if strpos(country,"Taiwan");
(71 real changes made)

. *Merge in mask data and keep only countries with non-missing data;
. preserve;

. clear;

. insheet using "`datadir'\graph_mask_requirements_v3B.csv";
(4 vars, 55 obs)

. tempfile maskdata;

. save `maskdata', replace;
(note: file C:\Users\jabal\AppData\Local\Temp\ST_4864_000004.tmp not found)
file C:\Users\jabal\AppData\Local\Temp\ST_4864_000004.tmp saved

. restore;

. merge m:1 country using `maskdata';

    Result                           # of obs.
    -----------------------------------------
    not matched                         5,957
        from master                     5,957  (_merge==1)
        from using                          0  (_merge==2)

    matched                            59,029  (_merge==3)
    -----------------------------------------

. assert _merge != 2;

. keep if mask_n != .;
(6,851 observations deleted)

. drop _merge;

. *Update date information;
. gen date = substr(update_time,1,10);

. replace date = subinstr(date,"-","",.);
(58,135 real changes made)

. keep country state county city date population confirmed deaths negative pending total_hospitalized_patients mask_n db_source_name;

. duplicates drop;

Duplicates in terms of all variables

(2,964 observations deleted)

. *Drop dates with missing case and death information;
. drop if confirmed == . | deaths == .;
(16,935 observations deleted)

. gen newdate = date(date,"YMD");

. *Drop final date since data may be incomplete;
. egen maxdate = max(newdate);

. drop if newdate == maxdate;
(17 observations deleted)

. drop maxdate;

. *For debugging;
. *sort country date state county city;
. *outsheet using sortedreports.csv, comma replace;
. ********************************************************************************************************;
. **SECTION 1: CLEAN DATA;
. ********************************************************************************************************;
. replace state = "NA" if state == "";
(1,639 real changes made)

. replace county = "NA" if county == "";
(7,318 real changes made)

. replace city = "NA" if city == "";
(38,219 real changes made)

. replace country = "French Polynesia" if state == "French Polynesia";
(16 real changes made)

. egen region = group(country state county city);

. sort region newdate;

. *Decide what sources to keep for each country;
. rename db_source_name source;

. egen eachcountrysource = tag(country newdate source);

. bys country newdate: egen sumsource = sum(eachcountrysource);

. tab sumsource;

  sumsource |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      3,290        8.61        8.61
          2 |     34,357       89.90       98.50
          3 |        572        1.50      100.00
------------+-----------------------------------
      Total |     38,219      100.00

. *If multiple records from the same source on the same date, keep only largest;
. bys region source newdate: gen numrecords = _N;

. bys region source newdate: egen maxconfirmed = max(confirmed);

. keep if confirmed == maxconfirmed;
(233 observations deleted)

. bys region source newdate: egen maxdeaths = max(deaths);

. keep if deaths == maxdeaths;
(1 observation deleted)

. bys region source newdate: gen numrecords2 = _N;

. assert numrecords2 == 1;

. drop numrecords maxconfirmed maxdeaths numrecords2;

. *In the US, Johns Hopkins data is redundant on days with COVID Project data;
. drop if source == "Johns Hopkins CSSE" & sumsource == 2 & country == "United States of America";
(31,267 observations deleted)

. *EU data is redundant with Johns Hopkins Data;
. drop if source == "EU Data";
(787 observations deleted)

. *Covid-19 Israel is redundant with Johns Hopkins Data;
. drop if source == "Covid-19 Israel";
(24 observations deleted)

. *Japan tracker is redundant with Johns Hopkins Data;
. drop if source == "Japan COVID-19 Coronavirus Tracker";
(49 observations deleted)

. *COVID-19-SG is redundant with Johns Hopkins Data;
. drop if source == "COVID-19-SG";
(57 observations deleted)

. *Korean data is redundant with Johns Hopkins Data;
. drop if source == "Korean Data";
(69 observations deleted)

. *Deal with redundant "UK" observations in UK;
. drop if state == "UK" & country == "United Kingdom";
(1 observation deleted)

. *Deal with "whole country" observations not labeled as "NA";
. replace state = "NA" if state == country;
(86 real changes made)

. drop region;

. egen region = group(country state county city);

. bys region newdate: gen counter = _N;

. tab counter;

    counter |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      5,731      100.00      100.00
------------+-----------------------------------
      Total |      5,731      100.00

. tab country if counter != 1;
no observations

. sort country newdate state source;

. assert counter == 1;

. /*;
> *For debugging, check countries where one region is large, confirm we're not double-counting;
> drop totinfect percinfect;
> bys country newdate: egen totinfect = sum(confirmed);
> gen percinfect = confirmed/totinfect;
> list country state county city newdate percinfect confirmed totinfect if percinfect > 0.2 & percinfect != 1;
> */;
. **Impute missing dates with the last non-missing value
> 
> *Create a dataset with every region date;
. preserve;

. keep newdate;

. duplicates drop;

Duplicates in terms of all variables

(5,661 observations deleted)

. gen join = 1;

. tempfile alldates;

. save `alldates', replace;
(note: file C:\Users\jabal\AppData\Local\Temp\ST_4864_000006.tmp not found)
file C:\Users\jabal\AppData\Local\Temp\ST_4864_000006.tmp saved

. restore;

. preserve;

. keep country region state county city;

. duplicates drop;

Duplicates in terms of all variables

(5,370 observations deleted)

. gen join = 1;

. joinby join using `alldates';

. tempfile allregiondates;

. save `allregiondates', replace;
(note: file C:\Users\jabal\AppData\Local\Temp\ST_4864_000008.tmp not found)
file C:\Users\jabal\AppData\Local\Temp\ST_4864_000008.tmp saved

. restore;

. merge 1:1  region newdate using `allregiondates';

    Result                           # of obs.
    -----------------------------------------
    not matched                        19,539
        from master                         0  (_merge==1)
        from using                     19,539  (_merge==2)

    matched                             5,731  (_merge==3)
    -----------------------------------------

. assert _merge == 3 | _merge == 2;

. bys  region: egen mindate = min(newdate);

. *All regions extend to the final date for that country;
. bys  country: egen maxdate = max(newdate);

. keep if newdate >= mindate & newdate <= maxdate;
(0 observations deleted)

. drop mindate maxdate;

. sort region newdate;

. by region: replace confirmed = confirmed[_n-1] if missing(confirmed);
(5,771 real changes made)

. by region: replace deaths = deaths[_n-1] if missing(deaths);
(5,771 real changes made)

. drop _merge;

. *If no earlier nonmissing values, set to 0;
. replace confirmed = 0 if confirmed == .;
(13,768 real changes made)

. replace deaths = 0 if deaths == .;
(13,768 real changes made)

. *If cumulative cases or deaths decline, replace all earlier larger values;
. *For example, if cases are 10, 30, 58, 28, 55, 100, 120 -- we would update to: 10, 28, 28, 55, 100, 120 ;
. gen confirmeddiff = confirmed-confirmed[_n-1] if region == region[_n-1];
(361 missing values generated)

. gen deathdiff = deaths-deaths[_n-1] if region == region[_n-1];
(361 missing values generated)

. gen flag = 1 if confirmeddiff < 0 | deathdiff < 0;
(25,213 missing values generated)

. bys region: egen maxflag = max(flag);
(21910 missing values generated)

. egen totflag = max(maxflag);

. local totflag = totflag;

. while(`totflag' > 0) {;
  2. gen flagdate = newdate if flag == 1;
  3. bys region: egen mindate = min(flagdate);
  4. gen flagconfirm = confirmed if newdate == mindate;
  5. bys region: egen maxflagconfirm = max(flagconfirm);
  6. *list country region date confirmed flagconfirm newdate mindate if country == "Japan";
. *assert 1 == 0;
. replace confirmed = maxflagconfirm if confirmed > maxflagconfirm & newdate <= mindate;
  7. gen flagdeaths = deaths if newdate == mindate;
  8. bys region: egen maxflagdeaths = max(flagdeaths);
  9. replace deaths = maxflagdeaths if deaths > maxflagdeaths & newdate <= mindate;
 10. replace flag = 0 if newdate == mindate;
 11. drop maxflag totflag flagdate flagconfirm flagdeaths mindate maxflagconfirm maxflagdeaths;
 12. bys region: egen maxflag = max(flag);
 13. egen totflag = sum(maxflag);
 14. local totflag = totflag;
 15. display "totflag is `totflag'";
 16. };
(25,213 missing values generated)
(21910 missing values generated)
(25,222 missing values generated)
(21910 missing values generated)
(65 real changes made)
(25,222 missing values generated)
(21910 missing values generated)
(13 real changes made)
(48 real changes made)
(21910 missing values generated)
totflag is 490
(25,261 missing values generated)
(24780 missing values generated)
(25,263 missing values generated)
(24780 missing values generated)
(7 real changes made)
(25,263 missing values generated)
(24780 missing values generated)
(3 real changes made)
(7 real changes made)
(21910 missing values generated)
totflag is 70
(25,268 missing values generated)
(25200 missing values generated)
(25,269 missing values generated)
(25200 missing values generated)
(1 real change made)
(25,269 missing values generated)
(25200 missing values generated)
(1 real change made)
(1 real change made)
(21910 missing values generated)
totflag is 70
(25,269 missing values generated)
(25200 missing values generated)
(25,269 missing values generated)
(25200 missing values generated)
(2 real changes made)
(25,269 missing values generated)
(25200 missing values generated)
(0 real changes made)
(1 real change made)
(21910 missing values generated)
totflag is 0

. drop maxflag totflag;

. *If "state" = "country", drop all other states to avoid double-counting;
. gen statecountry = (state == country);

. bys country newdate: egen maxstatecountry = max(statecountry);

. drop if maxstatecountry == 1 & statecountry != 1;
(0 observations deleted)

. drop statecountry maxstatecountry;

. *If "state" = "county", drop all other counties to avoid double-counting;
. gen statecounty = (state == county);

. replace statecounty = 1 if county == "";
(0 real changes made)

. replace statecounty = 1 if county == "NA";
(15,330 real changes made)

. bys country state newdate: egen maxstatecounty = max(statecounty);

. drop if maxstatecounty == 1 & statecounty != 1;
(7,140 observations deleted)

. drop statecounty maxstatecounty;

. *If "county" = "city", drop all other cities to avoid double-counting;
. gen countycity = (county == city);

. replace countycity = 1 if city == "";
(0 real changes made)

. replace countycity = 1 if city == "NA";
(70 real changes made)

. bys country state county newdate: egen maxcountycity = max(countycity);

. drop if maxcountycity == 1 & countycity != 1;
(0 observations deleted)

. drop countycity maxcountycity;

. ********************************************************************************************************;
. **SECTION 2: Merge in Policy Data;
. ********************************************************************************************************;
. *Rename countries so that they merge with Oxford data;
. replace country = "United States" if country == "United States of America";
(6,300 real changes made)

. replace country = "Czech Republic" if country == "Czechia";
(70 real changes made)

. merge m:1 country newdate using `oxdata';

    Result                           # of obs.
    -----------------------------------------
    not matched                         8,309
        from master                     1,604  (_merge==1)
        from using                      6,705  (_merge==2)

    matched                            16,526  (_merge==3)
    -----------------------------------------

. tab _merge;

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,604        6.46        6.46
         using only (2) |      6,705       27.00       33.46
            matched (3) |     16,526       66.54      100.00
------------------------+-----------------------------------
                  Total |     24,835      100.00

. *Confirm that all mask wearing countries merge;
. *Check countries which never merge in either direction;
. bys country: egen maxmerge = max(_merge);

. tab country if _merge == 1 & maxmerge != 3;
no observations

. tab country if _merge == 2 & maxmerge != 3;

                              country |      Freq.     Percent        Cum.
--------------------------------------+-----------------------------------
                          Afghanistan |         78        1.33        1.33
                              Albania |         17        0.29        1.62
                              Algeria |         83        1.42        3.03
                              Andorra |         14        0.24        3.27
                               Angola |          6        0.10        3.38
                  Antigua and Barbuda |          6        0.10        3.48
                              Armenia |         77        1.31        4.79
                           Azerbaijan |         81        1.38        6.17
                              Bahamas |          9        0.15        6.33
                              Bahrain |         85        1.45        7.77
                           Bangladesh |         13        0.22        8.00
                             Barbados |         86        1.47        9.46
                              Belarus |         80        1.36       10.83
                               Belize |         84        1.43       12.26
                                Benin |          9        0.15       12.41
                              Bermuda |         86        1.47       13.88
                               Bhutan |         15        0.26       14.13
                              Bolivia |         87        1.48       15.62
               Bosnia and Herzegovina |         15        0.26       15.87
                             Botswana |         85        1.45       17.32
                               Brunei |         16        0.27       17.60
                         Burkina Faso |         14        0.24       17.83
                             Cambodia |         79        1.35       19.18
                             Cameroon |         15        0.26       19.44
                           Cape Verde |          4        0.07       19.51
                       Cayman Islands |          6        0.10       19.61
             Central African Republic |         10        0.17       19.78
                                 Chad |          6        0.10       19.88
                                Chile |         86        1.47       21.35
                                Congo |         10        0.17       21.52
                           Costa Rica |         86        1.47       22.98
                        Cote d'Ivoire |         13        0.22       23.21
                              Croatia |         87        1.48       24.69
                                 Cuba |         13        0.22       24.91
                               Cyprus |         16        0.27       25.18
         Democratic Republic of Congo |         54        0.92       26.10
                             Djibouti |          7        0.12       26.22
                             Dominica |          2        0.03       26.26
                   Dominican Republic |         85        1.45       27.71
                              Ecuador |         85        1.45       29.16
                          El Salvador |         85        1.45       30.61
                    Equatorial Guinea |         11        0.19       30.79
                              Eritrea |          3        0.05       30.84
                              Estonia |         83        1.42       32.26
                             Ethiopia |         12        0.20       32.46
                       Faeroe Islands |          1        0.02       32.48
                                 Fiji |          6        0.10       32.58
                                Gabon |         13        0.22       32.80
                               Gambia |          8        0.14       32.94
                              Georgia |         84        1.43       34.37
                                Ghana |         13        0.22       34.60
                            Gibraltar |          1        0.02       34.61
                            Greenland |          6        0.10       34.71
                              Grenada |          2        0.03       34.75
                                 Guam |          7        0.12       34.87
                            Guatemala |         85        1.45       36.32
                               Guinea |         12        0.20       36.52
                               Guyana |         85        1.45       37.97
                                Haiti |          6        0.10       38.07
                             Honduras |         85        1.45       39.52
                              Hungary |         87        1.48       41.01
                              Iceland |         85        1.45       42.46
                                 Iraq |         85        1.45       43.90
                              Jamaica |         14        0.24       44.14
                               Jordan |         85        1.45       45.59
                           Kazakhstan |         11        0.19       45.78
                                Kenya |         85        1.45       47.23
                               Kuwait |         84        1.43       48.66
                      Kyrgyz Republic |          7        0.12       48.78
                                 Laos |         78        1.33       50.11
                               Latvia |         20        0.34       50.45
                              Lebanon |         84        1.43       51.88
                              Liberia |          9        0.15       52.04
                        Liechtenstein |         16        0.27       52.31
                            Lithuania |         78        1.33       53.64
                           Luxembourg |         82        1.40       55.04
                                Macao |         84        1.43       56.47
                            Macedonia |         80        1.36       57.83
                           Madagascar |          4        0.07       57.90
                             Maldives |         18        0.31       58.21
                                Malta |         18        0.31       58.52
                           Mauritania |         11        0.19       58.70
                            Mauritius |          6        0.10       58.81
                              Moldova |         17        0.29       59.10
                               Monaco |         74        1.26       60.36
                             Mongolia |         12        0.20       60.56
                           Montenegro |          8        0.14       60.70
                              Morocco |         18        0.31       61.01
                           Mozambique |          2        0.03       61.04
                              Myanmar |         79        1.35       62.39
                              Namibia |         11        0.19       62.57
                                Nepal |         74        1.26       63.84
                        New Caledonia |          4        0.07       63.90
                          New Zealand |         86        1.47       65.37
                            Nicaragua |         85        1.45       66.82
                                Niger |          4        0.07       66.89
                              Nigeria |         84        1.43       68.32
                               Norway |         85        1.45       69.77
                                 Oman |         82        1.40       71.17
                            Palestine |         20        0.34       71.51
                               Panama |         85        1.45       72.96
                     Papua New Guinea |          4        0.07       73.03
                             Paraguay |         17        0.29       73.32
                                 Peru |         19        0.32       73.64
                          Philippines |         82        1.40       75.04
                               Poland |         85        1.45       76.49
                             Portugal |         85        1.45       77.94
                                Qatar |         86        1.47       79.40
                               Rwanda |         11        0.19       79.59
                          Saint Lucia |         11        0.19       79.78
     Saint Vincent and the Grenadines |          2        0.03       79.81
                           San Marino |         85        1.45       81.26
                              Senegal |         18        0.31       81.57
                               Serbia |         87        1.48       83.05
                           Seychelles |         11        0.19       83.24
                      Slovak Republic |         85        1.45       84.69
                             Slovenia |         85        1.45       86.14
                              Somalia |          9        0.15       86.29
                            Sri Lanka |         87        1.48       87.77
                                Sudan |         12        0.20       87.98
                             Suriname |          6        0.10       88.08
                            Swaziland |         11        0.19       88.27
                                Syria |         85        1.45       89.72
                             Tanzania |         86        1.47       91.18
                                Timor |          3        0.05       91.24
                                 Togo |         13        0.22       91.46
                  Trinidad and Tobago |         13        0.22       91.68
                              Tunisia |         18        0.31       91.99
                               Uganda |         85        1.45       93.44
                              Ukraine |         14        0.24       93.67
                 United Arab Emirates |         85        1.45       95.12
         United States Virgin Islands |          1        0.02       95.14
                              Uruguay |         11        0.19       95.33
                           Uzbekistan |         10        0.17       95.50
                            Venezuela |         87        1.48       96.98
                              Vietnam |         85        1.45       98.43
                               Zambia |          7        0.12       98.55
                             Zimbabwe |         85        1.45      100.00
--------------------------------------+-----------------------------------
                                Total |      5,865      100.00

. bys country: egen maskmax = max(mask_n);
(5865 missing values generated)

. assert maxmerge == 3 if maskmax == 1;

. drop maxmerge maskmax;

. drop if _merge == 2;
(6,705 observations deleted)

. rename _merge origmerge;

. drop confirmedcases confirmeddeaths;

. rename confirmed confirmedcases;

. rename deaths confirmeddeaths;

. rename date origdate;

. rename newdate date;

. ********************************************************************************************************;
. **SECTION 3: Create regression variables;
. ********************************************************************************************************;
. if("`outcome'" == "confirmedcases") {;
. local start = "pos100";
. };

. if("`outcome'" == "confirmeddeaths") {;
. local start = "death10";
. };

. local geog = "country";

. *keep if county == state | state == "";
. preserve;

. gen regcount = 1;

. collapse (sum) confirmedcases confirmeddeaths regcount, by(`geog' date);

. *Find a date with at least 100 infections;
. gen pos100 = (confirmedcases >= 100) & confirmedcases != .;

. *Find date with at least 10 deaths;
. gen death10 = (confirmeddeaths >= 10) & confirmeddeaths != .;

. *gen ln`outcome' = ln(`outcome');
. *list `geog' date `outcome' ln`outcome' pos100 regcount if country == "Brazil", clean;
. *assert 1 == 0;
. keep `geog' date `start' `outcome';

. keep if `start' > 0;
(2,466 observations deleted)

. rename `outcome' init;

. bys `geog': egen mindate = min(date);

. keep if date == mindate;
(507 observations deleted)

. keep `geog' mindate init;

. duplicates drop;

Duplicates in terms of all variables

(0 observations are duplicates)

. tempfile mindate;

. save `mindate', replace;
(note: file C:\Users\jabal\AppData\Local\Temp\ST_4864_00000a.tmp not found)
file C:\Users\jabal\AppData\Local\Temp\ST_4864_00000a.tmp saved

. restore;

. capture drop mindate;

. merge m:1 `geog' using `mindate';

    Result                           # of obs.
    -----------------------------------------
    not matched                           420
        from master                       420  (_merge==1)
        from using                          0  (_merge==2)

    matched                            17,710  (_merge==3)
    -----------------------------------------

. assert _merge == 3 | _merge == 1;

. drop _merge;

. tab mindate;

    mindate |      Freq.     Percent        Cum.
------------+-----------------------------------
      21936 |      2,310       13.04       13.04
      21969 |      1,610        9.09       22.13
      21970 |         70        0.40       22.53
      21980 |      1,470        8.30       30.83
      21981 |        700        3.95       34.78
      21983 |         70        0.40       35.18
      21984 |      6,300       35.57       70.75
      21985 |        350        1.98       72.73
      21988 |        700        3.95       76.68
      21989 |         70        0.40       77.08
      21991 |         70        0.40       77.47
      21992 |        140        0.79       78.26
      21994 |      1,470        8.30       86.56
      21995 |        350        1.98       88.54
      21996 |        280        1.58       90.12
      21997 |         70        0.40       90.51
      21998 |         70        0.40       90.91
      22000 |        840        4.74       95.65
      22001 |        280        1.58       97.23
      22002 |        140        0.79       98.02
      22003 |        140        0.79       98.81
      22005 |        210        1.19      100.00
------------+-----------------------------------
      Total |     17,710      100.00

. gen twoweeks = mindate+14;
(420 missing values generated)

. gen onemonth = mindate+28;
(420 missing values generated)

. gen days10 = mindate+10;
(420 missing values generated)

. *Create regression variables;
. preserve;

. keep if date == mindate;
(17,877 observations deleted)

. keep `geog' mindate s1_s-s11_in;

. duplicates drop;

Duplicates in terms of all variables

(216 observations deleted)

. bys `geog': gen counter = _N;

. list if counter > 1;

. assert counter == 1;

. local regvar = "s1_schoolclosing s2_workplace s3_cancel s4_closepublic s5_publicinfo s6_restriction s7_international s8_fiscal s9_monet s10_emerg s11_invest";

. foreach x of local regvar {;
  2. rename `x' init_`x';
  3. gen blank_`x' = (init_`x' == .);
  4. replace init_`x' = 0 if init_`x' == .;
  5. };
(14 real changes made)
(15 real changes made)
(15 real changes made)
(15 real changes made)
(17 real changes made)
(15 real changes made)
(15 real changes made)
(23 real changes made)
(23 real changes made)
(27 real changes made)
(27 real changes made)

. keep `geog' init_* blank_*;

. tempfile initvars;

. save `initvars', replace;
(note: file C:\Users\jabal\AppData\Local\Temp\ST_4864_00000c.tmp not found)
file C:\Users\jabal\AppData\Local\Temp\ST_4864_00000c.tmp saved

. restore;

. preserve;

. gen enddate = mindate + 7;
(420 missing values generated)

. keep if date >= mindate & date <= enddate;
(16,181 observations deleted)

. keep `geog' date s1_s-s11_in;

. duplicates drop;

Duplicates in terms of all variables

(1,705 observations deleted)

. bys `geog': gen counter = _N;

. assert counter <= 8;

. local regvar = "s1_schoolclosing s2_workplace s3_cancel s4_closepublic s5_publicinfo s6_restriction s7_international s8_fiscal s9_monet s10_emerg s11_invest";

. gen avgcount = 1;

. collapse (mean) `regvar' (sum) avgcount, by(`geog');

. foreach x of local regvar {;
  2. rename `x' avg_var_`x';
  3. gen avg_blank_`x' = (avg_var_`x' == .);
  4. replace avg_var_`x' = 0 if avg_var_`x' == .;
  5. };
(14 real changes made)
(15 real changes made)
(15 real changes made)
(15 real changes made)
(16 real changes made)
(15 real changes made)
(15 real changes made)
(22 real changes made)
(23 real changes made)
(26 real changes made)
(26 real changes made)

. keep `geog' avg_* avgcount;

. tempfile avgvars;

. save `avgvars', replace;
(note: file C:\Users\jabal\AppData\Local\Temp\ST_4864_00000e.tmp not found)
file C:\Users\jabal\AppData\Local\Temp\ST_4864_00000e.tmp saved

. restore;

. gen time = date-mindate;
(420 missing values generated)

. keep if time >= 0 & time != .;
(11,316 observations deleted)

. *Populate missing mask values;
. bys country: egen maskmax = max(mask_n);

. replace mask_n = maskmax if mask_n == .;
(2,455 real changes made)

. *Is mask data consistent within every country?;
. gen masktest = mask_n;

. replace masktest = 2 if masktest == .;
(0 real changes made)

. bys country: egen sdmask = sd(masktest);
(3 missing values generated)

. by country: gen countdate = _N;

. assert sdmask == 0 | countdate == 1;

. drop masktest sdmask countdate;

. sort country time;

. tab country if mask_n != .;

                              country |      Freq.     Percent        Cum.
--------------------------------------+-----------------------------------
                            Argentina |          5        0.07        0.07
                            Australia |         66        0.97        1.04
                              Austria |         20        0.29        1.34
                              Belgium |         15        0.22        1.56
                               Brazil |         12        0.18        1.73
                               Canada |        240        3.52        5.25
                                China |      2,310       33.90       39.15
                             Colombia |          3        0.04       39.20
                       Czech Republic |          4        0.06       39.26
                              Denmark |         33        0.48       39.74
                                Egypt |         11        0.16       39.90
                              Finland |          3        0.04       39.95
                               France |        250        3.67       43.62
                              Germany |         17        0.25       43.87
                               Greece |         11        0.16       44.03
                                India |          9        0.13       44.16
                            Indonesia |         14        0.21       44.36
                                 Iran |         37        0.54       44.91
                              Ireland |          6        0.09       45.00
                               Israel |         10        0.15       45.14
                                Italy |        814       11.95       57.09
                                Japan |         23        0.34       57.43
                             Malaysia |         10        0.15       57.57
                               Mexico |          4        0.06       57.63
                          Netherlands |         84        1.23       58.86
                             Pakistan |          5        0.07       58.94
                              Romania |          8        0.12       59.05
                               Russia |          1        0.01       59.07
                         Saudi Arabia |          1        0.01       59.08
                          South Korea |         36        0.53       59.61
                                Spain |        546        8.01       67.63
                               Sweden |         14        0.21       67.83
                          Switzerland |         21        0.31       68.14
                             Thailand |          1        0.01       68.15
                               Turkey |         10        0.15       68.30
                       United Kingdom |        180        2.64       70.94
                        United States |      1,980       29.06      100.00
--------------------------------------+-----------------------------------
                                Total |      6,814      100.00

. tab mask_n;

mask_norm_s |
        ick |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      4,445       65.23       65.23
          1 |      2,369       34.77      100.00
------------+-----------------------------------
      Total |      6,814      100.00

. ********************************************************************************************************;
. **SECTION 4: Create graph;
. ********************************************************************************************************;
. if(`makegraph' == 1) {;
. collapse (sum) `outcome' population (mean) mask_n, by(`geog' time);
. gen ln`outcome' = ln(`outcome');
. drop ln`outcome';
. replace country = "USA" if strpos(country,"United States");
. bys `geog': egen maxpop = max(population);
. *Replace population for missing countries w/ > 5 million;
. tab country if maxpop == 0;
. *Replace population for missing countries w/ > 5 million;
. replace maxpop = 7392000 if country == "Hong Kong";
. replace maxpop = 5603000 if country == "Denmark";
. replace maxpop = 17180000 if country == "Netherlands";
. replace maxpop = 66990000 if country == "France";
. replace maxpop = 66440000 if country == "United Kingdom";
. assert maxpop != .;
. *Max population is total population of all infected regions;
. keep if maxpop > 5e6;
. *keep if time <= 20;
. gen ln`outcome' = ln(`outcome');
. keep if mask_norm_sick != .;
. drop `outcome' maxpop population mask_norm_sick;
. sort country time;
. drop if ln`outcome' == .;
. *Only keep countries with at least 8 days of data after baseline;
. bys country: gen numdays = _N;
. keep if numdays >= 8;
. drop numdays;
. *Use reshape by country;
. replace country = subinstr(country," ","",.);
. reshape wide lnconfirmedcases, i(time) j(country) string;
. *w/ 5 million cutoff
> *outsheet using "`datadir'\countrygraph.csv", comma replace;
. outsheet using "`datadir'\countrygraphG.csv", comma replace;
. foreach x of varlist * {;
  2. display "`x'";
  3. assert `x' >= `x'[_n-1] if `x'[_n-1] != .;
  4. };
. assert 1 == 0;
. };

. ********************************************************************************************************;
. **SECTION 4: Run cross-country regression;
. ********************************************************************************************************;
. *Create average growth rate;
. replace population = 0 if population == .;
(3,295 real changes made)

. sort `geog' time;

. /*;
> *For debugging;
> collapse (sum) confirmedcases confirmeddeaths (sum) population (mean) mask_n, by(`geog' date);
> sort country date;
> list country date confirmedcases confirmeddeaths if country == "Australia";
> list country date confirmedcases confirmeddeaths if country == "Austria";
> assert 1 == 0;
> */;
. collapse (sum) `outcome' (sum)  population (mean) mask_n, by(`geog' time);

. *For countries with only regional data, population is actually the sum of the population of infected regions;
. bys `geog': egen maxpop = max(population);

. tab country if maxpop == 0;
no observations

. *Replace population for missing countries w/ > 5 million;
. replace maxpop = 7392000 if country == "Hong Kong";
(0 real changes made)

. replace maxpop = 5603000 if country == "Denmark";
(11 real changes made)

. replace maxpop = 17180000 if country == "Netherlands";
(21 real changes made)

. replace maxpop = 66990000 if country == "France";
(25 real changes made)

. replace maxpop = 66440000 if country == "United Kingdom";
(18 real changes made)

. tab country if mask_n != .;

                              country |      Freq.     Percent        Cum.
--------------------------------------+-----------------------------------
                            Argentina |          5        0.92        0.92
                            Australia |          6        1.10        2.02
                              Austria |         10        1.84        3.86
                              Belgium |         15        2.76        6.62
                               Brazil |         12        2.21        8.82
                               Canada |         12        2.21       11.03
                                China |         70       12.87       23.90
                             Colombia |          3        0.55       24.45
                       Czech Republic |          4        0.74       25.18
                              Denmark |         11        2.02       27.21
                                Egypt |         11        2.02       29.23
                              Finland |          3        0.55       29.78
                               France |         25        4.60       34.38
                              Germany |         17        3.13       37.50
                               Greece |         11        2.02       39.52
                                India |          9        1.65       41.18
                            Indonesia |         14        2.57       43.75
                                 Iran |         37        6.80       50.55
                              Ireland |          6        1.10       51.65
                               Israel |          5        0.92       52.57
                                Italy |         37        6.80       59.38
                                Japan |         23        4.23       63.60
                             Malaysia |         10        1.84       65.44
                               Mexico |          4        0.74       66.18
                          Netherlands |         21        3.86       70.04
                             Pakistan |          5        0.92       70.96
                              Romania |          8        1.47       72.43
                               Russia |          1        0.18       72.61
                         Saudi Arabia |          1        0.18       72.79
                          South Korea |         36        6.62       79.41
                                Spain |         26        4.78       84.19
                               Sweden |         14        2.57       86.76
                          Switzerland |         21        3.86       90.63
                             Thailand |          1        0.18       90.81
                               Turkey |         10        1.84       92.65
                       United Kingdom |         18        3.31       95.96
                        United States |         22        4.04      100.00
--------------------------------------+-----------------------------------
                                Total |        544      100.00

. sort country time;

. assert maxpop != .;

. *Max population is total population of all infected regions;
. keep if maxpop > 5e6;
(0 observations deleted)

. keep if time <= 30;
(56 observations deleted)

. *Compute ln`outcome' at max time and inittime;
. gen ln`outcome' = ln(`outcome');

. drop if time == .;
(0 observations deleted)

. drop if ln`outcome' == .;
(0 observations deleted)

. bys `geog': egen maxtime = max(time);

. gen maxlntemp = ln`outcome' if time == maxtime;
(451 missing values generated)

. bys `geog': egen maxln = max(maxlntemp);

. gen initln = ln`outcome' if time == 0;
(451 missing values generated)

. bys `geog': egen minln = max(initln);

. gen growthrate = (maxln-minln)/maxtime;
(3 missing values generated)

. keep if time == maxtime;
(451 observations deleted)

. sort `geog';

. keep if maxtime >= 8;
(13 observations deleted)

. list `geog' maxtime growthrate, clean;

              country   maxtime   growth~e  
  1.          Austria         9   .2310491  
  2.          Belgium        14   .3039723  
  3.           Brazil        11   .2641281  
  4.           Canada        11   .1936558  
  5.            China        30    .162641  
  6.          Denmark        10    .193486  
  7.            Egypt        10   .1526056  
  8.           France        24   .2404885  
  9.          Germany        16   .2659355  
 10.           Greece        10   .1326871  
 11.            India         8   .1565954  
 12.        Indonesia        13   .1514012  
 13.             Iran        30   .1717924  
 14.            Italy        30   .2325716  
 15.            Japan        22   .0783076  
 16.         Malaysia         9   .1620683  
 17.      Netherlands        20   .2322195  
 18.      South Korea        30   .0857537  
 19.            Spain        25   .2968591  
 20.           Sweden        13   .2223363  
 21.      Switzerland        20   .1836421  
 22.           Turkey         9   .2183087  
 23.   United Kingdom        17   .2615955  
 24.    United States        21    .231496  

. merge m:1 country using `initvars';

    Result                           # of obs.
    -----------------------------------------
    not matched                            13
        from master                         0  (_merge==1)
        from using                         13  (_merge==2)

    matched                                24  (_merge==3)
    -----------------------------------------

. assert _merge != 1;

. keep if _merge == 3;
(13 observations deleted)

. drop _merge;

. merge m:1 country using `avgvars';

    Result                           # of obs.
    -----------------------------------------
    not matched                            13
        from master                         0  (_merge==1)
        from using                         13  (_merge==2)

    matched                                24  (_merge==3)
    -----------------------------------------

. assert _merge != 1;

. keep if _merge == 3;
(13 observations deleted)

. drop _merge;

. assert avgcount == 8;

. *Control mean;
. sum growthrate if mask_n == 1;

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
  growthrate |          3    .1089008    .0466891   .0783076    .162641

. *Treatment mean;
. sum growthrate if mask_n == 0;

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
  growthrate |         21    .2142331    .0491569   .1326871   .3039723

. *No controls;
. regress growthrate mask_n, robust;

Linear regression                               Number of obs     =         24
                                                F(1, 22)          =      17.12
                                                Prob > F          =     0.0004
                                                R-squared         =     0.3560
                                                Root MSE          =     .04894

--------------------------------------------------------------------------------
               |               Robust
    growthrate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
---------------+----------------------------------------------------------------
mask_norm_sick |  -.1053323   .0254559    -4.14   0.000    -.1581246     -.05254
         _cons |   .2142331   .0109339    19.59   0.000     .1915576    .2369085
--------------------------------------------------------------------------------

. drop init_s5-init_s11;

. drop blank_s5-blank_s11;

. drop avg_var_s5-avg_var_s11;

. drop avg_blank_s5-avg_blank_s11;

. *Baseline policy controls and testing;
. regress growthrate mask_n init_* blank_*, robust;
note: blank_s3_cancel omitted because of collinearity
note: blank_s4_closepublic omitted because of collinearity

Linear regression                               Number of obs     =         24
                                                F(5, 16)          =          .
                                                Prob > F          =          .
                                                R-squared         =     0.4612
                                                Root MSE          =     .05249

----------------------------------------------------------------------------------------
                       |               Robust
            growthrate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
        mask_norm_sick |  -.1068682    .019578    -5.46   0.000    -.1483717   -.0653647
 init_s1_schoolclosing |  -.0138215   .0163538    -0.85   0.410    -.0484901     .020847
     init_s2_workplace |  -.0076734   .0212409    -0.36   0.723    -.0527021    .0373554
        init_s3_cancel |  -.0024038   .0148931    -0.16   0.874    -.0339757    .0291682
   init_s4_closepublic |   .0129112   .0251117     0.51   0.614    -.0403232    .0661456
blank_s1_schoolclosing |  -.0166376   .0485185    -0.34   0.736    -.1194922    .0862171
    blank_s2_workplace |   -.032496   .0212409    -1.53   0.146    -.0775248    .0125327
       blank_s3_cancel |          0  (omitted)
  blank_s4_closepublic |          0  (omitted)
                 _cons |   .2455215   .0298953     8.21   0.000     .1821463    .3088967
----------------------------------------------------------------------------------------

. *Average policy controls and testing;
. regress growthrate mask_n avg_var* avg_blank_*, robust;
note: avg_blank_s3_cancel omitted because of collinearity
note: avg_blank_s4_closepublic omitted because of collinearity

Linear regression                               Number of obs     =         24
                                                F(6, 16)          =          .
                                                Prob > F          =          .
                                                R-squared         =     0.4180
                                                Root MSE          =     .05455

--------------------------------------------------------------------------------------------
                           |               Robust
                growthrate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
---------------------------+----------------------------------------------------------------
            mask_norm_sick |  -.1028168   .0235697    -4.36   0.000    -.1527823   -.0528513
  avg_var_s1_schoolclosing |  -.0137319    .016976    -0.81   0.430    -.0497193    .0222556
      avg_var_s2_workplace |  -.0061496   .0205001    -0.30   0.768    -.0496079    .0373087
         avg_var_s3_cancel |   .0048249   .0189066     0.26   0.802    -.0352553     .044905
    avg_var_s4_closepublic |   .0014748   .0257923     0.06   0.955    -.0532025    .0561521
avg_blank_s1_schoolclosing |  -.0144502   .0680645    -0.21   0.835    -.1587406    .1298401
    avg_blank_s2_workplace |  -.0285848   .0365356    -0.78   0.445    -.1060368    .0488673
       avg_blank_s3_cancel |          0  (omitted)
  avg_blank_s4_closepublic |          0  (omitted)
                     _cons |     .23841   .0403214     5.91   0.000     .1529325    .3238875
--------------------------------------------------------------------------------------------

. 
end of do-file

